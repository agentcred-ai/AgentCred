---
const apiUrl = import.meta.env.PUBLIC_AGENTCRED_API_URL ?? 'https://api.agentcred.dev';
---

<section id="verify" class="relative py-24 px-6">
	<div class="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
		<div
			class="absolute inset-0"
			style="background: radial-gradient(600px at 50% 0%, rgba(33, 231, 134, 0.18), transparent 70%);"
		></div>
		<div
			class="absolute inset-0 opacity-40"
			style="background-image: linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px); background-size: 48px 48px;"
		></div>
	</div>

	<div class="max-w-6xl mx-auto grid lg:grid-cols-[1.05fr_1.2fr] gap-12 items-start" data-verify-demo>
		<div class="space-y-6">
			<div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-accent-green">
				<span class="w-2 h-2 rounded-full bg-accent-green animate-pulse"></span>
				INSTANT VERIFICATION
			</div>
			<div class="flex flex-wrap gap-2 text-xs text-text-secondary">
				<span class="px-2.5 py-1 rounded-full border border-white/10 bg-white/5">No login required</span>
				<span class="px-2.5 py-1 rounded-full border border-white/10 bg-white/5">OAuth only for signing</span>
			</div>
			<h2 class="text-4xl lg:text-headline font-display font-bold leading-tight">
				Verify an AgentCred envelope in seconds.
			</h2>
			<p class="text-lg text-text-secondary">
				Paste an envelope or HTML snippet, and we will validate the signature, content hash, and GitHub identity.
			</p>
			<ul class="space-y-3 text-sm text-text-secondary">
				<li class="flex items-center gap-3">
					<span class="w-5 h-5 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-xs">✓</span>
					Signature validity (Ed25519 + JWS)
				</li>
				<li class="flex items-center gap-3">
					<span class="w-5 h-5 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-xs">✓</span>
					Content hash integrity
				</li>
				<li class="flex items-center gap-3">
					<span class="w-5 h-5 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-xs">✓</span>
					GitHub identity registry
				</li>
			</ul>
			<div class="text-xs text-text-secondary/80">
				Tip: Verification is public. GitHub OAuth is only needed when you start signing.
			</div>
		</div>

		<div class="space-y-6">
			<div class="bg-card border border-white/10 rounded-2xl overflow-hidden shadow-elevated">
				<div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
					<div class="flex items-center gap-2">
						<div class="w-2.5 h-2.5 rounded-full bg-accent-green"></div>
						<span class="text-sm font-semibold">Verification Console</span>
					</div>
					<span class="text-xs text-text-secondary font-mono">API: {apiUrl}</span>
				</div>

				<div class="px-5 pt-5 pb-5 space-y-4">
					<div class="flex items-center gap-2 text-xs text-text-secondary">
						<input type="radio" name="verify-tab" id="verify-tab-envelope" value="envelope" class="peer/envelope hidden" checked>
						<label for="verify-tab-envelope" class="px-3 py-1 rounded-full border border-white/10 bg-white/5 cursor-pointer peer-checked/envelope:bg-accent-green/15 peer-checked/envelope:text-accent-green">Envelope</label>

						<input type="radio" name="verify-tab" id="verify-tab-html" value="html" class="peer/html hidden">
						<label for="verify-tab-html" class="px-3 py-1 rounded-full border border-white/10 bg-white/5 cursor-pointer peer-checked/html:bg-accent-green/15 peer-checked/html:text-accent-green">HTML</label>
					</div>

					<div class="peer-checked/envelope:block hidden">
						<textarea
							id="verify-input-envelope"
							class="w-full h-40 rounded-xl bg-black/30 border border-white/10 p-4 text-sm font-mono text-text-primary placeholder:text-text-secondary/60 focus:outline-none focus:ring-2 focus:ring-accent-green"
							placeholder="Paste an AgentCred envelope JSON..."
						></textarea>
					</div>
					<div class="peer-checked/html:block hidden">
						<textarea
							id="verify-input-html"
							class="w-full h-40 rounded-xl bg-black/30 border border-white/10 p-4 text-sm font-mono text-text-primary placeholder:text-text-secondary/60 focus:outline-none focus:ring-2 focus:ring-accent-green"
							placeholder="Paste HTML with data-agentcred..."
						></textarea>
					</div>

					<div class="flex flex-col sm:flex-row gap-3">
						<button
							id="verify-sample"
							class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 text-text-secondary hover:text-white hover:border-white/20 transition-colors"
						>
							Try verified demo
						</button>
						<button
							id="verify-submit"
							class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 text-text-secondary hover:text-white hover:border-white/20 transition-colors"
						>
							Verify now
						</button>
					</div>

					<p class="text-xs text-text-secondary/70">
						First time here? Click <span class="text-text-primary">Try verified demo</span> to see a real verification.
					</p>
					<p class="text-xs text-text-secondary/70">
						Verification proves authorship, not truthfulness.
					</p>
				</div>
			</div>

			<div id="verify-result" class="bg-surface border border-white/10 rounded-2xl p-5">
				<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
					<div class="flex items-center gap-4">
						<div id="verify-status-icon" class="w-11 h-11 rounded-xl bg-white/5 text-text-secondary flex items-center justify-center text-lg">•</div>
						<div>
							<div id="verify-status-badge" class="inline-flex px-3 py-1 rounded-full text-xs uppercase tracking-wider bg-white/5 text-text-secondary">Idle</div>
						<h3 id="verify-status-title" class="text-lg font-semibold mt-2">Paste an envelope or use the sample.</h3>
						<p id="verify-status-subtitle" class="text-sm text-text-secondary">We will validate signature, hash, and registry.</p>
					</div>
				</div>
				</div>

				<div class="mt-6 grid sm:grid-cols-3 gap-3">
					<div class="rounded-xl border border-white/5 bg-black/30 p-4">
						<div class="text-xs text-text-secondary">GitHub</div>
						<div id="verify-github" class="text-sm font-mono mt-1 text-text-primary">—</div>
					</div>
					<div class="rounded-xl border border-white/5 bg-black/30 p-4">
						<div class="text-xs text-text-secondary">Agent</div>
						<div id="verify-agent" class="text-sm font-mono mt-1 text-text-primary">—</div>
					</div>
					<div class="rounded-xl border border-white/5 bg-black/30 p-4">
						<div class="text-xs text-text-secondary">Signed</div>
						<div id="verify-signed" class="text-sm font-mono mt-1 text-text-primary">—</div>
					</div>
				</div>

				<div class="mt-6">
					<div class="text-xs uppercase tracking-wider text-text-secondary mb-3">Trust breakdown</div>
					<ul class="space-y-2">
						<li class="flex items-center gap-3 text-sm text-text-secondary" data-check="signature">
							<span class="flex items-center justify-center w-6 h-6 rounded-full bg-white/5 text-text-secondary" data-icon>•</span>
							<span data-label>Signature valid</span>
						</li>
						<li class="flex items-center gap-3 text-sm text-text-secondary" data-check="hash">
							<span class="flex items-center justify-center w-6 h-6 rounded-full bg-white/5 text-text-secondary" data-icon>•</span>
							<span data-label>Content hash matches</span>
						</li>
						<li class="flex items-center gap-3 text-sm text-text-secondary" data-check="key">
							<span class="flex items-center justify-center w-6 h-6 rounded-full bg-white/5 text-text-secondary" data-icon>•</span>
							<span data-label>Key registered to GitHub</span>
						</li>
					</ul>
					<p id="verify-reason" class="text-xs text-text-secondary/80 mt-3">Awaiting verification.</p>
				</div>

				<div class="mt-6 border-t border-white/10 pt-4">
					<div class="text-xs uppercase tracking-wider text-text-secondary">Share this verification</div>
					<div class="mt-3 flex flex-col sm:flex-row gap-3">
						<input
							id="verify-share-link"
							class="flex-1 rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-xs font-mono text-text-primary/80"
							readonly
							value="Verify an envelope to generate a share link."
						/>
						<button id="verify-open-link" class="px-3 py-2 text-xs rounded-lg border border-white/10 text-text-secondary hover:text-white hover:border-white/20 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Open</button>
					</div>
				</div>
			</div>

			<div class="bg-card border border-white/10 rounded-2xl p-5">
				<div class="flex items-center justify-between gap-4">
					<div>
						<div class="text-xs uppercase tracking-wider text-text-secondary">Next step</div>
						<h3 class="text-lg font-semibold mt-2">Start signing in 3 minutes.</h3>
						<p class="text-sm text-text-secondary mt-2">
							Verification is public and instant. Signing requires a one-time GitHub OAuth link.
						</p>
					</div>
					<div class="hidden sm:flex items-center justify-center w-12 h-12 rounded-xl bg-accent-green/15 text-accent-green text-xl">
						✓
					</div>
				</div>
				<ul class="mt-4 space-y-2 text-xs text-text-secondary">
					<li class="flex items-center gap-2">
						<span class="w-4 h-4 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-[10px]">1</span>
						Connect GitHub once (OAuth).
					</li>
					<li class="flex items-center gap-2">
						<span class="w-4 h-4 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-[10px]">2</span>
						Sign output via CLI, SDK, or MCP tools.
					</li>
					<li class="flex items-center gap-2">
						<span class="w-4 h-4 rounded-full bg-accent-green/20 text-accent-green flex items-center justify-center text-[10px]">3</span>
						Share a verification link with every result.
					</li>
				</ul>
				<div class="mt-4 flex flex-col sm:flex-row gap-3">
					<a href="#quickstart" class="flex-1 inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-accent-green text-black font-semibold hover:bg-accent-green/90 transition-colors">
						Start signing (OAuth)
					</a>
					<a href="https://github.com/agentcred-ai/agentcred/blob/main/docs/guide.md" target="_blank" class="flex-1 inline-flex items-center justify-center px-4 py-2.5 rounded-lg border border-white/10 text-text-secondary hover:text-white hover:border-white/20 transition-colors">
						Read the Docs
					</a>
				</div>
			</div>
		</div>
	</div>

	<script type="module" define:vars={{ apiUrl }}>
		const API_URL = apiUrl;

	// Safe to commit: JWS contains only public data (no private keys)
	const DEMO_ENVELOPE = {
		agentcred: {
			v: '1.0',
			jws: 'eyJhbGciOiJFZERTQSIsInR5cCI6ImFnZW50Y3JlZCtqd3QiLCJraWQiOiJoc3BhcmsxMjEyQGFnZW50Y3JlZCJ9.eyJpc3MiOiJoc3BhcmsxMjEyQGFnZW50Y3JlZCIsInN1YiI6IndlYnNpdGUtZGVtbyIsImlhdCI6MTc3MDIzNzA4MSwiY29udGVudF9oYXNoIjoic2hhMjU2OjJkMmQ4N2RhNDFkYTJlZDYzZTQ4NDkwOWUyZmM4MWEyNTdlYzFlMWYyMWZiZTk4NTJkY2RjZGMwNDExYjViZmMiLCJjb250ZW50X3R5cGUiOiJ0ZXh0L3BsYWluIiwibm9uY2UiOiI1Zjk0YWNjNS0xODc0LTQ2MDMtYThmZi02NWY1YzlmZGU1MzcifQ.qd9GUEOOEfZaIQBAXWzILor5qjosf9oUdo3cO47v5g__I4QFn451-TkNVaWrpqkcqUTzcBonUrdRdDIiByThDw',
			github: 'hspark1212',
			agent: 'website-demo',
		},
		content: 'AgentCred demo message\n',
	};

		const demo = document.querySelector('[data-verify-demo]');
		if (demo) {
			const envelopeInput = demo.querySelector('#verify-input-envelope');
			const htmlInput = demo.querySelector('#verify-input-html');
			const verifyButton = demo.querySelector('#verify-submit');
			const sampleButton = demo.querySelector('#verify-sample');
			const statusIcon = demo.querySelector('#verify-status-icon');
			const statusBadge = demo.querySelector('#verify-status-badge');
			const statusTitle = demo.querySelector('#verify-status-title');
			const statusSubtitle = demo.querySelector('#verify-status-subtitle');
			const githubEl = demo.querySelector('#verify-github');
			const agentEl = demo.querySelector('#verify-agent');
			const signedEl = demo.querySelector('#verify-signed');
			const reasonEl = demo.querySelector('#verify-reason');
				const shareLinkInput = demo.querySelector('#verify-share-link');
				const openLinkBtn = demo.querySelector('#verify-open-link');

			const trustItems = {
				signature: demo.querySelector('[data-check="signature"]'),
				hash: demo.querySelector('[data-check="hash"]'),
				key: demo.querySelector('[data-check="key"]'),
			};

			const sampleEnvelope = JSON.stringify(DEMO_ENVELOPE, null, 2);
			const demoMetadata = {
				v: DEMO_ENVELOPE.agentcred.v,
				jws: DEMO_ENVELOPE.agentcred.jws,
				github: DEMO_ENVELOPE.agentcred.github,
				agent: DEMO_ENVELOPE.agentcred.agent,
			};
			const sampleHtml = (() => {
				const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(demoMetadata))));
				return `<span data-agentcred="${encoded}">${DEMO_ENVELOPE.content}</span>`;
			})();

			let lastEnvelope = null;
			let lastResult = null;
			let shareLink = '';

			const emphasisClasses = [
				'bg-accent-green/15',
				'text-accent-green',
				'border-accent-green/30',
				'shadow-glow-green',
				'animate-pulse',
				'hover:bg-accent-green/25',
				'hover:text-accent-green',
				'hover:border-accent-green/50',
			];

			function setEmphasis(target) {
				if (sampleButton) {
					sampleButton.classList.remove(...emphasisClasses);
				}
				if (verifyButton) {
					verifyButton.classList.remove(...emphasisClasses);
				}

				if (target === 'sample' && sampleButton) {
					sampleButton.classList.add(...emphasisClasses);
				}
				if (target === 'verify' && verifyButton) {
					verifyButton.classList.add(...emphasisClasses);
				}
			}

			const badgeBase = 'inline-flex px-3 py-1 rounded-full text-xs uppercase tracking-wider';
			const iconBase = 'w-11 h-11 rounded-xl flex items-center justify-center text-lg';

			function setStatus(state, title, subtitle) {
				let badgeClass = '';
				let iconClass = '';
				let iconText = '•';
				let badgeText = 'Idle';

				switch (state) {
					case 'verifying':
						badgeText = 'Verifying';
						badgeClass = `${badgeBase} bg-amber-500/15 text-amber-300`;
						iconClass = `${iconBase} bg-amber-500/15 text-amber-300`;
						iconText = '⏳';
						break;
					case 'verified':
						badgeText = 'Verified';
						badgeClass = `${badgeBase} bg-accent-green/15 text-accent-green`;
						iconClass = `${iconBase} bg-accent-green/15 text-accent-green`;
						iconText = '✓';
						break;
					case 'unverified':
						badgeText = 'Unverified';
						badgeClass = `${badgeBase} bg-accent-red/15 text-accent-red`;
						iconClass = `${iconBase} bg-accent-red/15 text-accent-red`;
						iconText = '✕';
						break;
					case 'error':
						badgeText = 'Error';
						badgeClass = `${badgeBase} bg-accent-red/15 text-accent-red`;
						iconClass = `${iconBase} bg-accent-red/15 text-accent-red`;
						iconText = '!';
						break;
					default:
						badgeText = 'Idle';
						badgeClass = `${badgeBase} bg-white/5 text-text-secondary`;
						iconClass = `${iconBase} bg-white/5 text-text-secondary`;
						iconText = '•';
				}

				statusBadge.className = badgeClass;
				statusBadge.textContent = badgeText;
				statusIcon.className = iconClass;
				statusIcon.textContent = iconText;
				statusTitle.textContent = title;
				statusSubtitle.textContent = subtitle;
			}

			function setActionsEnabled(enabled, link = '') {
				if (openLinkBtn) openLinkBtn.disabled = !link;
				if (shareLinkInput) {
					shareLinkInput.value = link || 'Verify an envelope to generate a share link.';
				}
				shareLink = link;
			}

			function setTrustState(key, state) {
				const item = trustItems[key];
				if (!item) return;
				const icon = item.querySelector('[data-icon]');
				const label = item.querySelector('[data-label]');
				let iconText = '•';
				let iconClass = 'flex items-center justify-center w-6 h-6 rounded-full bg-white/5 text-text-secondary';

				if (state === 'pass') {
					iconText = '✓';
					iconClass = 'flex items-center justify-center w-6 h-6 rounded-full bg-accent-green/15 text-accent-green';
				} else if (state === 'fail') {
					iconText = '✕';
					iconClass = 'flex items-center justify-center w-6 h-6 rounded-full bg-accent-red/15 text-accent-red';
				}

				if (icon) {
					icon.textContent = iconText;
					icon.className = iconClass;
				}
			}

			function resetMeta() {
				githubEl.textContent = '—';
				agentEl.textContent = '—';
				signedEl.textContent = '—';
				reasonEl.textContent = 'Awaiting verification.';
				setTrustState('signature', 'unknown');
				setTrustState('hash', 'unknown');
				setTrustState('key', 'unknown');
				setActionsEnabled(false, '');
			}

			function parseEnvelope(raw) {
				try {
					const parsed = JSON.parse(raw);
					if (!parsed?.agentcred?.v || !parsed?.agentcred?.jws || !parsed?.agentcred?.github) {
						return { ok: false, error: 'This does not look like an AgentCred envelope.' };
					}
					return { ok: true, envelope: parsed };
				} catch {
					return { ok: false, error: 'Invalid JSON format.' };
				}
			}

			function parseHtml(raw) {
				try {
					const parser = new DOMParser();
					const doc = parser.parseFromString(raw, 'text/html');
					const target = doc.querySelector('[data-agentcred]');
					if (!target) {
						return { ok: false, error: 'No data-agentcred attribute found.' };
					}
					const encoded = target.getAttribute('data-agentcred');
					if (!encoded) {
						return { ok: false, error: 'Missing data-agentcred value.' };
					}
					const decoded = JSON.parse(decodeURIComponent(escape(atob(encoded))));
					if (!decoded?.v || !decoded?.jws || !decoded?.github) {
						return { ok: false, error: 'Invalid AgentCred metadata.' };
					}
					return {
						ok: true,
						envelope: {
							agentcred: decoded,
							content: target.textContent || '',
						},
					};
				} catch {
					return { ok: false, error: 'Unable to parse HTML metadata.' };
				}
			}

			function getActiveTab() {
				const active = demo.querySelector('input[name=\"verify-tab\"]:checked');
				return active ? active.value : 'envelope';
			}

			function encodeEnvelope(envelope) {
				try {
					const json = JSON.stringify(envelope);
					return btoa(unescape(encodeURIComponent(json)));
				} catch {
					return '';
				}
			}

		function isDemoEnvelope(envelope) {
			return envelope?.agentcred?.jws === DEMO_ENVELOPE.agentcred.jws;
		}



			function buildShareLink(envelope) {
				const encoded = encodeEnvelope(envelope);
				if (!encoded) return '';
				const url = new URL('/verify', window.location.origin);
				url.searchParams.set('envelope', encoded);
				return url.toString();
			}

			function flashButton(button, text) {
				if (!button) return;
				const original = button.textContent;
				button.textContent = text;
				setTimeout(() => {
					button.textContent = original;
				}, 1200);
			}

			async function runVerify() {
				const tab = getActiveTab();
				const raw = (tab === 'html' ? htmlInput.value : envelopeInput.value).trim();
				if (!raw) {
					setStatus('idle', 'Paste an envelope or use the sample.', 'We will validate signature, hash, and registry.');
					resetMeta();
					return;
				}

				const parsed = tab === 'html' ? parseHtml(raw) : parseEnvelope(raw);
				if (!parsed.ok) {
					setStatus('error', 'Invalid input format.', parsed.error);
					resetMeta();
					reasonEl.textContent = parsed.error;
					return;
				}

			lastEnvelope = parsed.envelope;
			setActionsEnabled(true, buildShareLink(lastEnvelope));
			setStatus('verifying', 'Verifying signature…', 'Checking signature, hash, and registry.');
			reasonEl.textContent = 'Checking against the AgentCred API…';
			setTrustState('signature', 'unknown');
			setTrustState('hash', 'unknown');
			setTrustState('key', 'unknown');

			try {
					const res = await fetch(`${API_URL}/v1/verify`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ envelope: lastEnvelope }),
					});
					const data = await res.json().catch(() => ({}));

					if (!res.ok || data?.verified === false) {
						const errorMessage = data?.error || 'Verification failed.';
						setStatus('unverified', 'Unverified envelope.', errorMessage);
						reasonEl.textContent = errorMessage;
						githubEl.textContent = lastEnvelope?.agentcred?.github ? `@${lastEnvelope.agentcred.github}` : '—';
						agentEl.textContent = lastEnvelope?.agentcred?.agent || '—';
						signedEl.textContent = '—';
						setActionsEnabled(true, buildShareLink(lastEnvelope));

						if (String(errorMessage).toLowerCase().includes('content hash')) {
							setTrustState('hash', 'fail');
						} else if (String(errorMessage).toLowerCase().includes('key')) {
							setTrustState('key', 'fail');
						} else {
							setTrustState('signature', 'fail');
						}
						return;
					}

					setStatus('verified', `Verified by @${data.github.username}`, 'Signature and registry confirmed.');
					reasonEl.textContent = 'Signature valid, content intact, key registered.';
					githubEl.textContent = `@${data.github.username}`;
					agentEl.textContent = data.agent || lastEnvelope?.agentcred?.agent || '—';
					signedEl.textContent = data.signed_at ? new Date(data.signed_at).toLocaleString() : '—';
					setTrustState('signature', 'pass');
					setTrustState('hash', 'pass');
					setTrustState('key', 'pass');
					setActionsEnabled(true, buildShareLink(lastEnvelope));
					lastResult = data;
				} catch {
					setStatus('error', 'Verification server unreachable.', 'Try again later.');
					reasonEl.textContent = 'Verification server unreachable. Try again later.';
					setActionsEnabled(true, buildShareLink(lastEnvelope));
				}
			}

			function pasteSample() {
				const tab = getActiveTab();
				if (tab === 'html') {
					htmlInput.value = sampleHtml;
				} else {
					envelopeInput.value = sampleEnvelope;
				}
			}

			async function copyText(text) {
				if (!text) return;
				try {
					await navigator.clipboard.writeText(text);
				} catch {
					const textarea = document.createElement('textarea');
					textarea.value = text;
					document.body.appendChild(textarea);
					textarea.select();
					document.execCommand('copy');
					textarea.remove();
				}
			}

			openLinkBtn?.addEventListener('click', () => {
				if (!shareLink) return;
				window.open(shareLink, '_blank', 'noopener');
			});

			sampleButton?.addEventListener('click', () => {
				pasteSample();
				setEmphasis('verify');
			});

			verifyButton?.addEventListener('click', () => {
				setEmphasis(null);
				void runVerify();
			});

			setEmphasis('sample');

			const params = new URLSearchParams(window.location.search);
			const encodedEnvelope = params.get('envelope');
			if (encodedEnvelope && envelopeInput) {
				try {
					const decoded = decodeURIComponent(escape(atob(encodedEnvelope)));
					envelopeInput.value = decoded;
					runVerify();
				} catch {}
			}
		}
	</script>
</section>
